name: Build Nightly Wheels

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *"  # Everyday at 4:00am UTC/8:00pm PST

jobs:
  trigger:
    runs-on: ubuntu-latest
    outputs:
      linux-matrix: ${{ steps.set-matrix.outputs.linux-matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure matrix
        id: set-matrix
        run: |
          # Set Linux matrix
          filename=".github/workflows/utils/full_matrix_linux.json"
          matrix=$(jq -c '[.[] | { "torch-version": .["torch-version"], "python-version": .["python-version"][], "cuda-version": .["cuda-version"][] }]' $filename)
          echo "linux-matrix=$matrix" >> $GITHUB_OUTPUT
          echo "linux-matrix=$matrix"

  linux:
    needs: [trigger]
    uses: ./.github/workflows/_build_linux.yml
    with:
      test-matrix: ${{ needs.trigger.outputs.linux-matrix }}
      release-type: nightly
      docker-hub-username: ${{ vars.DOCKERHUB_USERNAME }}
    secrets:
      docker-hub-token: ${{ secrets.DOCKERHUB_TOKEN }}
      aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  index:
    if: always()
    needs: [linux]
    uses: ./.github/workflows/_upload_index.yml
    with:
      release-type: nightly
    secrets: inherit
